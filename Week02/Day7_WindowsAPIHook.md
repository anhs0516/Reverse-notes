### Windows 메시지 후킹 (Message Hooking)
#### 🔍 훅(Hook)이란?
**훅(Hook)**은 본래 갈고리, 낚시바늘이라는 뜻으로, 특정 이벤트나 동작이 발생했을 때 그 정보를 가로채기 위해 사용하는 기술입니다.

운영체제(OS)나 프로그램 사이에서 주고받는 정보를 중간에 가로채서 분석하거나 조작할 수 있게 해줍니다.

보안, 디버깅, 사용자 인터페이스 확장 등에 사용됩니다.

예: 키보드 입력을 가로채서 입력 내용을 엿보거나(키로거), 마우스 이벤트를 조작하여 자동화 프로그램을 만들 수 있음.

#### 💬 메시지(Message)란?
Windows는 GUI 기반 이벤트(Event) 처리 시스템을 사용합니다.

사용자가 키보드를 누르거나 마우스를 클릭하는 등의 행위가 이벤트입니다.

OS는 이벤트가 발생하면 해당 프로그램(윈도우)에 **메시지(Message)**를 전달합니다.

예: WM_KEYDOWN, WM_MOUSEMOVE, WM_CLOSE 등

#### 🎣 메시지 훅(Message Hook)이란?
메시지 훅은 OS에서 프로그램으로 전달되는 메시지를 중간에 가로채서 처리할 수 있는 기능입니다.

이를 통해 사용자가 어떤 키를 눌렀는지, 마우스로 어떤 행동을 했는지 등을 파악할 수 있습니다.

#### 🔗 훅 체인(Hook Chain)
하나의 이벤트에 대해 여러 개의 훅을 동시에 설치할 수 있습니다.

이 훅들은 체인처럼 연결되어 순서대로 호출됩니다. 이를 **훅 체인(Hook Chain)**이라 부릅니다.

#### 🧰 훅 설치 함수: SetWindowsHookEx
Windows에서 훅을 설치하려면 다음 함수를 사용합니다:

```text
HHOOK SetWindowsHookExA(
  int       idHook,      // 훅의 종류 (예: WH_KEYBOARD_LL)
  HOOKPROC  lpfn,        // 콜백 함수 포인터
  HINSTANCE hmod,        // DLL 핸들 (글로벌 훅 시 필요)
  DWORD     dwThreadId   // 스레드 ID (0이면 전체 시스템(Global Hook))
);
```

주요 파라미터 설명:

| 파라미터         | 설명                                                       |
| ------------ | -------------------------------------------------------- |
| `idHook`     | 훅의 종류 (예: `WH_KEYBOARD`, `WH_MOUSE`, `WH_KEYBOARD_LL` 등) |
| `lpfn`       | 이벤트 발생 시 호출될 **콜백 함수(HOOKPROC)**                         |
| `hmod`       | 훅 함수가 포함된 DLL 핸들 (글로벌 훅일 경우 필요)                          |
| `dwThreadId` | 훅을 걸 대상 스레드 ID <br>→ `0`이면 시스템 전체에 적용하는 **글로벌 훅**        |


#### 🔁 콜백 함수 (Hook Procedure)
- 사용자가 지정한 훅이 작동되었을 때 실행되는 함수입니다.
- 이 함수에서 메시지를 확인하거나 조작할 수 있습니다.

```
LRESULT CALLBACK KeyboardProc(int nCode, WPARAM wParam, LPARAM lParam) {
    if (nCode >= 0) {
        // 메시지 처리 예: 키 입력 확인
    }
    return CallNextHookEx(NULL, nCode, wParam, lParam);  // 다음 훅으로 메시지 전달
}
```

#### 🧪 메시지 훅 도구 예시: SPY++
SPY++: Microsoft Visual Studio에 포함된 도구

윈도우 메시지 흐름을 모니터링하여, 어떤 윈도우가 어떤 메시지를 받고 있는지 시각적으로 확인할 수 있음

#### ⚠️ 주의 사항
글로벌 훅을 설치할 경우, 콜백 함수가 들어 있는 코드는 반드시 DLL 형태로 만들어야 합니다.

보안상 민감한 기능이므로 안티바이러스나 보안 솔루션에 의해 차단될 수 있습니다.

너무 많은 훅 설치는 시스템 성능에 영향을 줄 수 있습니다.

#### 📌 참고 Hook 종류
| idHook 값         | 설명                       |
| ---------------- | ------------------------ |
| `WH_KEYBOARD`    | 키보드 입력 감지                |
| `WH_MOUSE`       | 마우스 이벤트 감지               |
| `WH_KEYBOARD_LL` | 저수준 키보드 입력 (글로벌에서 자주 사용) |
| `WH_MOUSE_LL`    | 저수준 마우스 입력               |
| `WH_CALLWNDPROC` | 메시지가 윈도우 프로시저로 전달될 때 감지  |

#### ✅ 요약
Windows의 메시지 기반 구조를 활용해 이벤트를 가로채고 조작할 수 있는 기능이 Hook이다.

SetWindowsHookEx() 함수를 통해 다양한 종류의 훅을 설치할 수 있다.

훅 체인을 통해 여러 훅이 연결되어 동작하며, 콜백 함수에서 이벤트를 처리한다.

SPY++ 등의 도구를 통해 실제 메시지 흐름을 확인할 수 있다.

